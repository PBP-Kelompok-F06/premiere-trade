{% extends 'base.html' %}
{% load static %}
{% block title %}Club Saya - Premiere Trade{% endblock %}

{% block content %}
<div class="club-saya-container mx-20 mt-5">
  <h1 class="text-3xl font-bold mb-4">My Club</h1>

  {% if user.profile.managed_club.name == "Manchester City" %}
  <div class="flex items-center bg-[#6CABDD] text-white rounded-lg">
    <img class="logo-club height-500 w-20 mr-8 ml-5"
      src="https://tmssl.akamaized.net//images/wappen/head/9265.png?lm=1467356331 py-5" alt="">
    <h1 class="nama-club text-2xl font-semibold">{{ user.profile.managed_club }}</h1>
  </div>
  {% elif user.profile.managed_club.name == "Chelsea" %}
  <div class="flex items-center bg-[#034694] text-white rounded-lg">
    <img class="logo-club height-500 w-20 mr-8 ml-5"
      src="https://tmssl.akamaized.net//images/wappen/head/41573.png?lm=1682435911 py-5" alt="">
    <h1 class="nama-club text-2xl font-semibold">{{ user.profile.managed_club }}</h1>
  </div>
  {% elif user.profile.managed_club.name == "Arsenal" %}
  <div class="flex items-center bg-[#EF0107] text-white rounded-lg">
    <img class="logo-club height-500 w-20 mr-8 ml-5"
      src="https://tmssl.akamaized.net//images/wappen/head/41571.png?lm=1489787850 py-5" alt="">
    <h1 class="nama-club text-2xl font-semibold">{{ user.profile.managed_club }}</h1>
  </div>
  {% elif user.profile.managed_club.name == "Liverpool" %}
  <div class="flex items-center bg-white text-black rounded-lg border border-gray-200 py-5">
    <img class="logo-club height-500 w-20 mr-8 ml-5"
      src="https://tmssl.akamaized.net//images/wappen/head/45333.png?lm=1727873452" alt="">
    <h1 class="nama-club text-2xl font-semibold">{{ user.profile.managed_club }}</h1>
  </div>
  {% endif %}

  <div class="list-pemain mt-8">
    <h1 class="text-3xl font-semibold mb-3">Daftar Pemain</h1>

    <div class="overflow-x-auto w-full">
    <table class="min-w-[1150px] w-full border-collapse bg-white rounded-lg overflow-hidden shadow mb-12">
      <thead>
        <tr class="bg-gradient-to-r from-indigo-800 via-purple-700 to-purple-500 text-white text-center">
          <th class="py-5 px-2"></th>
          <th class="py-5 px-2">Nama Pemain</th>
          <th class="py-5 px-2">Posisi</th>
          <th class="py-5 px-2">Umur</th>
          <th class="py-5 px-2">Negara</th>
          <th class="py-5 px-2">Match</th>
          <th class="py-5 px-2">Goal</th>
          <th class="py-5 px-2">Assist</th>
          <th class="py-5 px-2">Market Value</th>
          <th class="py-5 px-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="player-table-body">
        <!-- Akan diisi otomatis lewat AJAX -->
        <tr id="loading-row">
          <td colspan="10" class="text-center py-6 text-gray-500">Memuat data pemain...</td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

  <!-- MODAL -->
  <div id="sellModal"
    class="modal hidden fixed inset-0 z-10 bg-black bg-opacity-50 flex items-center justify-center align-items-center">
    <div
      class="modal-content bg-white w-[600px] h-[450px] rounded-xl shadow-2xl relative p-5 pt-2 mt-[100px] ml-[450px] animate-[fadeIn_0.3s_ease]">
      <span class="close absolute right-5 top-2 text-[28px] text-gray-400 hover:text-black cursor-pointer">&times;</span>

      <div class="modal-body flex items-center gap-5 mt-[30px]">
        <div class="modal-image-container flex flex-col justify-center items-center gap-2">
          <img id="modal-thumbnail" class="modal-img w-[200px] rounded-md" src="" alt="Player photo">
          <img id="modal-logo" src="{% static 'images/logo.png' %}" alt="Logo" class="modal-logo w-[100px]">
        </div>

        <div class="modal-info mx-2 space-y-3">
          <h2 id="modal-nama" class="text-2xl font-semibold mb-1"></h2>
          <p><b>Posisi:</b> <span id="modal-posisi"></span></p>
          <p><b>Umur:</b> <span id="modal-umur"></span></p>
          <p><b>Negara:</b> <span id="modal-negara"></span></p>
          <p><b>Total Match:</b> <span id="modal-match"></span></p>
          <p><b>Total Goal:</b> <span id="modal-goal"></span></p>
          <p><b>Total Assist:</b> <span id="modal-assist"></span></p>
          <p><b>Market Value:</b> Rp<span id="modal-value"></span></p>
        </div>
      </div>

      <div class="modal-footer flex justify-end mt-5">
        <button id="cancelButton"
          class="cancel-btn bg-gray-300 text-black px-4 py-2 rounded-md hover:bg-gray-400 transition mr-3">Cancel</button>
        <button id="confirmSellButton"
          class="confirm-btn bg-[#ff3838] text-white px-4 py-2 rounded-md hover:bg-[#e02828] transition">Sell
          Player</button>
      </div>
    </div>
  </div>
</div>

<!-- Tailwind Animation -->
<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>
  const csrfToken = "{{ csrf_token }}";

  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("sellModal");
    const closeBtn = document.querySelector(".close");
    const cancelBtn = document.getElementById("cancelButton");
    const confirmBtn = document.getElementById("confirmSellButton");
    const modalImg = document.getElementById("modal-thumbnail");
    const modalNama = document.getElementById("modal-nama");
    const modalPosisi = document.getElementById("modal-posisi");
    const modalUmur = document.getElementById("modal-umur");
    const modalNegara = document.getElementById("modal-negara");
    const modalMatch = document.getElementById("modal-match");
    const modalGoal = document.getElementById("modal-goal");
    const modalAssist = document.getElementById("modal-assist");
    const modalValue = document.getElementById("modal-value");

    const tbody = document.getElementById("player-table-body");

    // 🔹 Ambil data pemain via AJAX
    fetch("{% url 'player_transaction:list_pemain_saya' %}", {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(res => res.json())
      .then(data => {
        tbody.innerHTML = ""; // kosongkan tbody
        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10" class="text-center py-6 text-gray-500">Belum ada pemain yang terdaftar.</td></tr>`;
          return;
        }

        data.forEach(p => {
          const row = document.createElement("tr");
          row.dataset.playerId = p.id;
          row.className = "text-center border-b hover:bg-[#f4f8ff]";
          row.innerHTML = `
            <td><img class="foto-pemain w-[50px] rounded-md inline-block" src="${p.thumbnail}" alt=""></td>
            <td class="nama-pemain font-medium py-5">${p.nama_pemain}</td>
            <td>${p.posisi}</td>
            <td>${p.umur}</td>
            <td>${p.negara}</td>
            <td>${p.match}</td>
            <td>${p.goal}</td>
            <td>${p.assist}</td>
            <td>Rp${parseInt(p.market_value).toLocaleString("id-ID")}</td>
            <td>
              ${p.sedang_dijual
              ? `<button class="sell-button border border-gray-300 bg-gray-200 text-gray-500 px-3 py-1 rounded-md cursor-not-allowed opacity-60" disabled>Sedang Dijual</button>`
              : `<button class="sell-button border-[1.5px] border-[#ff3838] text-[#ff3838] bg-white px-3 py-[6px] rounded-md hover:bg-[#ff3838] hover:text-white transition cursor-pointer">Jual</button>`
            }
            </td>
          `;
          tbody.appendChild(row);
        });

        attachSellButtonHandlers();
      })
      .catch(() => {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center py-6 text-red-500">Gagal memuat data pemain.</td></tr>`;
      });

    // 🔹 Fungsi untuk aktifkan event listener pada tombol jual
    function attachSellButtonHandlers() {
      document.querySelectorAll(".sell-button").forEach(button => {
        button.addEventListener("click", function () {
          const row = this.closest("tr");
          const nama = row.querySelector(".nama-pemain").innerText;
          const posisi = row.children[2].innerText;
          const umur = row.children[3].innerText;
          const negara = row.children[4].innerText;
          const match = row.children[5].innerText;
          const goal = row.children[6].innerText;
          const assist = row.children[7].innerText;
          const value = row.children[8].innerText.replace("Rp", "");
          const foto = row.querySelector(".foto-pemain").src;

          modalImg.src = foto;
          modalNama.innerText = nama;
          modalPosisi.innerText = posisi;
          modalUmur.innerText = umur;
          modalNegara.innerText = negara;
          modalMatch.innerText = match;
          modalGoal.innerText = goal;
          modalAssist.innerText = assist;
          modalValue.innerText = value;
          modal.style.display = "block";
        });
      });
    }

    // 🔹 Modal handler
    closeBtn.onclick = () => modal.style.display = "none";
    cancelBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

    // 🔹 Konfirmasi jual
    confirmBtn.onclick = () => {
      const playerName = modalNama.innerText;
      const playerRow = Array.from(document.querySelectorAll(".nama-pemain"))
        .find(td => td.innerText === playerName);
      if (!playerRow) return;

      const playerId = playerRow.closest("tr").dataset.playerId;
      fetch(`/player_transaction/jual/${playerId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`✅ ${data.message}`);
            modal.style.display = "none";
            const sellButton = playerRow.closest("tr").querySelector(".sell-button");
            sellButton.innerText = "Sedang Dijual";
            sellButton.disabled = true;
            sellButton.classList.add("opacity-60", "cursor-not-allowed");
          } else {
            alert("❌ Gagal menjual pemain.");
          }
        })
        .catch(() => alert("Terjadi kesalahan saat menghubungi server."));
    };
  });
</script>
{% endblock %}
