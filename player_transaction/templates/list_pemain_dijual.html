{% extends 'base.html' %}
{% load static %}

{% block title %}Transfer Market - Premiere Trade{% endblock %}

{% block content %}

<div class="mx-auto my-12 p-5 w-[90%] max-w-[1200px] bg-[#fdfdfd] rounded-lg shadow-md">
  <h1 class="text-center mb-1 text-[28px] text-[#333] font-semibold">Transfer Market</h1>
  <p class="text-center text-gray-500 mb-6">Lihat semua pemain yang sedang dijual oleh klub lain</p>

  <table class="w-full border-collapse bg-white rounded-lg overflow-hidden">
    <thead>
      <tr class="bg-gradient-to-r from-indigo-800 via-purple-700 to-purple-500 text-white">
        <th class="p-3"></th>
        <th class="p-3">Nama Pemain</th>
        <th class="p-3">Club Asal</th>
        <th class="p-3">Posisi</th>
        <th class="p-3">Umur</th>
        <th class="p-3">Negara</th>
        <th class="p-3">Match</th>
        <th class="p-3">Goal</th>
        <th class="p-3">Asis</th>
        <th class="p-3">Market Value</th>
        {% if user.is_club_admin %}
        <th class="p-3">Aksi</th>
        {% endif %}
      </tr>
    </thead>
    <tbody id="pemain-dijual-body">
      <!-- Data akan diisi otomatis oleh AJAX -->
      <tr><td colspan="11" class="text-center py-6 text-gray-500">Memuat data pemain...</td></tr>
    </tbody>
  </table>
</div>

<!-- ðŸ”¹ Modal -->
<div id="sellModal" class="fixed inset-0 z-10 hidden flex items-center justify-center bg-black bg-opacity-50">
  <div
    class="modal-content bg-white w-[600px] h-[450px] rounded-xl shadow-2xl relative p-5 pt-[5px] transition-all duration-300 animate-[fadeIn_0.3s_ease]">
    <span class="close absolute right-5 top-2 text-[28px] text-gray-400 hover:text-black cursor-pointer">&times;</span>

    <div class="modal-body flex items-center gap-5 mt-[30px]">
      <div class="flex flex-col justify-center items-center gap-2">
        <img id="modal-thumbnail" class="w-[200px] rounded-md" src="" alt="Player photo">
        <img id="modal-logo" src="{% static 'images/logo.png' %}" alt="Logo" class="w-[100px]">
      </div>

      <div class="modal-info mx-2 space-y-3">
        <h2 id="modal-nama" class="text-2xl font-semibold mb-1"></h2>
        <p><b>Posisi:</b> <span id="modal-posisi"></span></p>
        <p><b>Umur:</b> <span id="modal-umur"></span></p>
        <p><b>Negara:</b> <span id="modal-negara"></span></p>
        <p><b>Total Match:</b> <span id="modal-match"></span></p>
        <p><b>Total Goal:</b> <span id="modal-goal"></span></p>
        <p><b>Total Assist:</b> <span id="modal-assist"></span></p>
        <p><b>Market Value:</b> Rp<span id="modal-value"></span></p>

        <!-- ðŸ”¹ Input Negosiasi -->
        <div id="nego-input-container" class="hidden mt-2">
          <label for="nego-input" class="block font-semibold text-[14px] text-gray-800 mb-1">Masukkan Harga Penawaran (Rp):</label>
          <input id="nego-input" type="number" min="1"
            class="w-full px-3 py-[6px] border border-gray-300 rounded-md text-[14px] focus:outline-none focus:ring-2 focus:ring-purple-300">
        </div>
      </div>
    </div>

    <div class="modal-footer flex justify-end mt-5">
      <button id="cancelButton" class="bg-gray-300 text-black px-4 py-2 rounded-md hover:bg-gray-400 transition mr-3">Cancel</button>
      <button id="confirmSellButton" class="bg-[#ff3838] text-white px-4 py-2 rounded-md hover:bg-[#e02828] transition">Confirm</button>
    </div>
  </div>
</div>


<style>
@keyframes fadeIn {
  from {opacity: 0; transform: scale(0.95);}
  to {opacity: 1; transform: scale(1);}
}
</style>


<script defer>
document.addEventListener("DOMContentLoaded", () => {
  const csrfToken = "{{ csrf_token }}";
  const tbody = document.getElementById("pemain-dijual-body");
  const modal = document.getElementById("sellModal");
  const closeBtn = modal.querySelector(".close");
  const cancelBtn = modal.querySelector("#cancelButton");
  const confirmBtn = modal.querySelector("#confirmSellButton");
  const modalContent = modal.querySelector(".modal-content");

  const nama = document.getElementById("modal-nama");
  const posisi = document.getElementById("modal-posisi");
  const umur = document.getElementById("modal-umur");
  const negara = document.getElementById("modal-negara");
  const match = document.getElementById("modal-match");
  const goal = document.getElementById("modal-goal");
  const assist = document.getElementById("modal-assist");
  const value = document.getElementById("modal-value");
  const thumbnail = document.getElementById("modal-thumbnail");
  const negoInputContainer = document.getElementById("nego-input-container");

  let currentAction = null;
  let currentPlayerId = null;

  // ðŸ”¹ Load data pemain via AJAX
  fetch("{% url 'player_transaction:list_pemain_dijual_json' %}", {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(res => res.json())
  .then(data => {
    tbody.innerHTML = "";

    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" class="text-center py-6 text-gray-500">Belum ada pemain yang dijual.</td></tr>`;
      return;
    }

    data.forEach(player => {
      const row = document.createElement("tr");
      row.dataset.playerId = player.id;
      row.className = "text-center border-b border-gray-200 hover:bg-[#f4f8ff] transition";

      row.innerHTML = `
        <td><img src="${player.thumbnail}" class="w-[50px] h-auto rounded-lg inline-block"></td>
        <td>${player.nama_pemain}</td>
        <td>${player.nama_klub}</td>
        <td>${player.posisi}</td>
        <td>${player.umur}</td>
        <td>${player.negara}</td>
        <td>${player.match}</td>
        <td>${player.goal}</td>
        <td>${player.assist}</td>
        <td>Rp${parseInt(player.market_value).toLocaleString("id-ID")}</td>
        {% if user.is_club_admin %}
        <td class="relative">
          <div class="relative inline-block w-[25px] cursor-pointer p-[5px] rounded-md hover:bg-gray-200">
            <button class="menu-trigger bg-transparent border-none text-[18px] text-gray-700">â‹®</button>
            <div class="menu-dropdown hidden absolute right-0 bg-white min-w-[130px] max-w-[150px] border border-gray-300 rounded-md shadow-lg z-10">
              ${
                player.nama_klub === "{{ user.profile.managed_club.name }}" ?
                `<button class="menu-item block w-full text-left px-3 py-2 hover:bg-gray-100 cancel-sale" data-id="${player.id}">Batal Jual</button>` :
                `
                <button class="menu-item block w-full text-left px-3 py-2 hover:bg-gray-100 buy-player" data-id="${player.id}">Beli</button>
                <button class="menu-item block w-full text-left px-3 py-2 hover:bg-gray-100 nego-player" data-id="${player.id}">Negosiasi</button>
                `
              }
            </div>
          </div>
        </td>
        {% endif %}
      `;
      tbody.appendChild(row);
    });

    attachDropdownEvents();
  })
  .catch(() => {
    tbody.innerHTML = `<tr><td colspan="11" class="text-center py-6 text-red-500">Gagal memuat data pemain.</td></tr>`;
  });

  // ðŸ”¹ Dropdown dan Modal Logic (sama seperti sebelumnya)
  function attachDropdownEvents() {
    document.querySelectorAll(".menu-trigger").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        document.querySelectorAll(".menu-dropdown-floating").forEach(d => d.remove());
        const dropdownTemplate = btn.nextElementSibling.cloneNode(true);
        dropdownTemplate.classList.add("menu-dropdown-floating");
        dropdownTemplate.style.display = "block";
        dropdownTemplate.style.position = "absolute";
        const rect = btn.getBoundingClientRect();
        dropdownTemplate.style.top = rect.bottom + window.scrollY + "px";
        dropdownTemplate.style.left = rect.right + window.scrollX - 150 + "px";
        document.body.appendChild(dropdownTemplate);
        document.addEventListener("click", () => dropdownTemplate.remove(), { once: true });

        dropdownTemplate.querySelectorAll(".menu-item").forEach(menuItem => {
          menuItem.addEventListener("click", () => {
            dropdownTemplate.remove();
            const playerId = menuItem.dataset.id;
            const row = document.querySelector(`tr[data-player-id="${playerId}"]`);
            const action = menuItem.classList.contains("buy-player") ? "buy" :
                          menuItem.classList.contains("nego-player") ? "nego" : "cancel";
            currentAction = action;
            currentPlayerId = playerId;

            nama.textContent = row.children[1].textContent;
            posisi.textContent = row.children[3].textContent;
            umur.textContent = row.children[4].textContent;
            negara.textContent = row.children[5].textContent;
            match.textContent = row.children[6].textContent;
            goal.textContent = row.children[7].textContent;
            assist.textContent = row.children[8].textContent;
            value.textContent = row.children[9].textContent.replace("Rp", "");
            thumbnail.src = row.querySelector("img").src;

            confirmBtn.classList.remove("buy", "nego", "cancel");

            if (action === "buy") {
              confirmBtn.textContent = "Confirm Purchase";
              negoInputContainer.style.display = "none";
              confirmBtn.className = "bg-green-300 hover:bg-green-400 text-black px-4 py-2 rounded-md transition";
            } else if (action === "nego") {
              confirmBtn.textContent = "Negosiasi";
              negoInputContainer.style.display = "block";
              confirmBtn.className = "bg-yellow-300 hover:bg-yellow-400 text-black px-4 py-2 rounded-md transition";
            } else {
              confirmBtn.textContent = "Batalkan Penjualan";
              negoInputContainer.style.display = "none";
              confirmBtn.className = "bg-[#ff3838] text-white px-4 py-2 rounded-md hover:bg-[#e02828] transition";
            }
            modal.style.display = "flex";
          });
        });
      });
    });
  }

  // ðŸ”¹ Modal close handlers
  const closeModal = () => { modal.style.display = "none"; };
  closeBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  window.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  // ðŸ”¹ Konfirmasi aksi (buy/nego/cancel)
  confirmBtn.addEventListener("click", async () => {
    if (!currentAction || !currentPlayerId) return;

    try {
      let res, data;

      if (currentAction === "buy") {
        res = await fetch(`/player_transaction/beli/${currentPlayerId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
        });
      } else if (currentAction === "nego") {
        const hargaInput = document.getElementById("nego-input");
        const harga = hargaInput.value.trim();
        if (!harga || isNaN(harga) || parseInt(harga) <= 0) {
          alert("Masukkan harga penawaran yang valid!");
          return;
        }
        res = await fetch(`/player_transaction/send-negotiation/${currentPlayerId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify({ offered_price: harga }),
        });
      } else {
        res = await fetch(`/player_transaction/batalkan-jual/${currentPlayerId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
        });
      }

      data = await res.json();
      alert(data.message);
      location.reload();
    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan: " + err.message);
    }

    closeModal();
  });
});
</script>

{% endblock %}
