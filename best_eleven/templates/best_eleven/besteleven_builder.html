{% extends "base.html" %}
{% load static tailwind_tags %} 

{% block title %}Best XI Team Builder{% endblock title %}

{% block content %}

<div class="container mx-auto max-w-7xl px-4 py-8">
    <h1 class="text-4xl font-extrabold text-center mb-8 bg-gradient-to-r from-purple-600 via-pink-500 to-purple-600 text-transparent bg-clip-text">
        Best XI Team Builder
    </h1>

    {# Global Status Message Area #}
    <div id="global-status" class="min-h-[40px] mb-6 transition-all duration-300"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {# Kolom Kiri: Saved Formations #}
        <div class="bg-gray-50 border-2 border-pink-500 rounded-xl p-6 shadow-lg flex flex-col h-full">
            <h2 class="text-xl font-bold text-purple-900 mb-4 pb-4 border-b-2 border-pink-500 flex justify-between items-center gap-2">
                <span>üíæ Saved Formations</span>
                <a href="{% url 'best_eleven:besteleven-list' %}" class="text-xs font-medium text-purple-600 hover:text-pink-600 hover:underline transition-colors" title="Lihat Semua Formasi">
                    Lihat Semua
                </a>
            </h2>
            <div id="history-list" class="overflow-y-auto flex-grow max-h-[60vh] pr-2 scrollbar-thin scrollbar-thumb-purple-400 scrollbar-track-gray-200">
                <p class="empty-state text-center py-8 text-gray-500 italic">Loading history...</p>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="new-formation-btn" class="w-full py-2 px-4 rounded-md text-white font-bold bg-gradient-to-r from-purple-600 to-pink-500 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 text-sm">
                    + NEW FORMATION
                </button>
            </div>
        </div>

        {# Kolom Tengah: Pitch #}
        <div class="bg-gray-50 border-2 border-pink-500 rounded-xl p-6 shadow-lg">
            <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-purple-50 rounded-lg">
                <input type="text" id="formation-name" placeholder="‚úèÔ∏è Formation Name (e.g., Dream Team)" class="flex-1 bg-white text-purple-900 border-2 border-pink-500 rounded-md py-2 px-4 text-sm focus:outline-none focus:border-purple-600 focus:ring-1 focus:ring-purple-600 placeholder-gray-400">
                <select id="formation-layout-select" class="bg-white text-purple-900 border-2 border-pink-500 rounded-md py-2 px-4 text-sm focus:outline-none focus:border-purple-600 focus:ring-1 focus:ring-purple-600">
                    <option value="4-3-3">4-3-3</option>
                    <option value="4-4-2">4-4-2</option>
                    <option value="3-5-2">3-5-2</option>
                    <option value="4-2-3-1">4-2-3-1</option>
                </select>
            </div>

            <div id="pitch"
                 class="relative w-full bg-cover bg-center rounded-lg grid grid-rows-5 grid-cols-5 py-2 h-[450px] md:h-[550px] shadow-inner"
                 style="background-image: url('{% static 'images/lapangan.jpg' %}')"
                 >
                 {# Pitch slots will be rendered here by JS #}
            </div>

            <div class="flex justify-between items-center mt-6 pt-6 border-t-2 border-pink-500 gap-4">
                <button id="clear-formation-btn" class="font-semibold py-2 px-6 rounded-md border-none cursor-pointer transition-all duration-300 text-sm flex items-center gap-2 bg-gradient-to-r from-red-600 to-red-800 text-white hover:translate-y-[-2px] hover:shadow-lg">
                    üóëÔ∏è Clear Players
                </button>
                <button id="save-formation-btn" class="font-semibold py-2 px-6 rounded-md border-none cursor-pointer transition-all duration-300 text-sm flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white flex-1 hover:enabled:translate-y-[-2px] hover:enabled:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    üíæ Save Formation
                </button>
            </div>
        </div>

        {# Kolom Kanan: Player List #}
        <div class="bg-gray-50 border-2 border-pink-500 rounded-xl p-6 shadow-lg flex flex-col h-full">
            <h2 class="text-xl font-bold text-purple-900 mb-4 pb-4 border-b-2 border-pink-500">
                <span>üìã Player List</span>
            </h2>

            <div class="mb-4">
                <label for="club-select" class="block text-gray-500 text-sm mb-2 font-medium">üèÜ Filter by Club</label>
                <select id="club-select" class="w-full bg-white text-purple-900 border-2 border-pink-500 rounded-md py-2 px-4 text-sm focus:outline-none focus:border-purple-600 focus:ring-1 focus:ring-purple-600">
                    <option value="">Loading clubs...</option>
                </select>
            </div>

            <div class="flex justify-between items-center mb-3">
                <span id="filter-position-label" class="text-purple-900 text-sm font-semibold">Select club or position</span>
                <button id="clear-filter-btn" class="hidden bg-none border-none text-red-400 text-xs cursor-pointer transition-colors duration-300 px-2 py-1 hover:text-red-600 hover:underline">‚úï Clear Filter</button>
            </div>

            <div id="player-list" class="overflow-y-auto flex-grow max-h-[60vh] pr-2 scrollbar-thin scrollbar-thumb-purple-400 scrollbar-track-gray-200">
                <p class="empty-state text-center py-8 text-gray-500 italic">Loading players...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SEMUA LOGIKA JAVASCRIPT ANDA TETAP SAMA ---
    // --- KECUALI PERUBAHAN PADA FUNGSI YANG MEMANIPULASI CLASS ---

    let allClubs = [];
    let allHistory = [];
    let currentPlayers = [];
    let currentSquad = []; // Array of { player: PlayerObject, originalSlotId: string }
    let selectedPlayers = []; // Array of { player: PlayerObject, slotId: string } (for pitch display)
    let selectedSlotId = null;
    let currentFilterPositionCode = null;
    let currentLayout = '4-3-3';
    let currentFormationId = null;

    const pitch = document.getElementById('pitch');
    const clubSelect = document.getElementById('club-select');
    const formationLayoutSelect = document.getElementById('formation-layout-select');
    const formationNameInput = document.getElementById('formation-name');
    const playerListContainer = document.getElementById('player-list');
    const historyListContainer = document.getElementById('history-list');
    const saveFormationBtn = document.getElementById('save-formation-btn');
    const clearFormationBtn = document.getElementById('clear-formation-btn');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const globalStatus = document.getElementById('global-status');
    const filterPositionLabel = document.getElementById('filter-position-label');
    const newFormationBtn = document.getElementById('new-formation-btn');

    const formationLayouts = { /* ... SAMA ... */
        '4-3-3': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LCM', 'CM', 'RCM', 'LW', 'ST', 'RW'],
        '4-4-2': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LM', 'LCM', 'RCM', 'RM', 'LST', 'RST'],
        '3-5-2': ['GK', 'LCB', 'CB', 'RCB', 'LWB', 'LCM', 'RCM', 'RWB', 'CAM', 'LST', 'RST'],
        '4-2-3-1': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LDM', 'RDM', 'LAM', 'CAM', 'RAM', 'ST']
    };
    const slotPositionMap = { /* ... SAMA ... */
        'GK': 'Kiper', 'LB': 'Bek-Kiri', 'LWB': 'Bek-Kiri',
        'LCB': 'Bek-Tengah', 'CB': 'Bek-Tengah', 'RCB': 'Bek-Tengah',
        'RB': 'Bek-Kanan', 'RWB': 'Bek-Kanan', 'LDM': 'Gel. Bertahan',
        'RDM': 'Gel. Bertahan', 'LM': 'Sayap Kiri', 'LCM': 'Gel. Tengah',
        'CM': 'Gel. Tengah', 'RCM': 'Gel. Tengah', 'RM': 'Sayap Kanan',
        'LAM': 'Sayap Kiri', 'CAM': 'Gel. Serang', 'RAM': 'Sayap Kanan',
        'LW': 'Sayap Kiri', 'RW': 'Sayap Kanan', 'LST': 'Penyerang',
        'ST': 'Penyerang', 'RST': 'Penyerang'
    };
    const indonesianToRoleMap = { /* ... SAMA ... */
        'Kiper': ['Kiper'], 'Bek-Tengah': ['Bek-Tengah'], 'Bek-Kanan': ['Bek-Kanan'],
        'Bek-Kiri': ['Bek-Kiri'], 'Gel. Bertahan': ['Gel. Bertahan', 'Gel. Tengah'],
        'Gel. Serang': ['Gel. Serang', 'Gel. Tengah', 'Sayap Kiri', 'Sayap Kanan'],
        'Gel. Tengah': ['Gel. Tengah', 'Gel. Bertahan', 'Gel. Serang'],
        'Sayap Kiri': ['Sayap Kiri', 'Gel. Serang', 'Bek-Kiri'],
        'Sayap Kanan': ['Sayap Kanan', 'Gel. Serang', 'Bek-Kanan'],
        'Penyerang': ['Penyerang'], 'Depan-Tengah': ['Penyerang']
    };

    function getCookie(name) { /* ... SAMA ... */
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function fetchInitialData() { /* ... SAMA ... */
        showStatus("Mengambil data klub & histori...", true);
        try {
            const response = await fetch("{% url 'best_eleven:api_builder_data' %}");
            if (!response.ok) throw new Error(`Gagal memuat data awal. (Error: ${response.status})`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            allClubs = data.clubs;
            allHistory = data.history;
            renderClubSelect();
            renderHistoryList();
            await fetchPlayers();
            reAssignPlayersToPitch(); 
        } catch (error) {
            console.error("Error fetchInitialData:", error);
            showStatus(`Error: ${error.message}. (Mungkin belum login?)`, true);
        }
    }
    async function fetchPlayers(clubId = null) { /* ... SAMA ... */
        showStatus("Mengambil data pemain...", true);
        try {
            let url = "{% url 'best_eleven:api_get_players' %}";
            if (clubId) {
                url += `?club_id=${clubId}`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Gagal memuat pemain (Error: ${response.status})`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            currentPlayers = data.players; 
            renderPlayerList(); 
            showStatus("Daftar pemain diperbarui.", false);
        } catch (error) {
            console.error("Error fetchPlayers:", error);
            showStatus(`Error: ${error.message}.`, true);
        }
    }
    async function saveFormation() { /* ... SAMA ... */
        const formationName = formationNameInput.value.trim();
        if (currentSquad.length !== 11 || !formationName) {
            alert("Nama formasi harus diisi dan pemain harus lengkap (11 pemain).");
            return;
        }
        showStatus("Menyimpan formasi...", true);
        saveFormationBtn.disabled = true;
        const dataToSave = {
            name: formationName,
            layout: currentLayout,
            formation_id: currentFormationId,
            player_ids: currentSquad.map(s => ({
                slotId: s.originalSlotId, 
                playerId: s.player.id
            }))
        };
        try {
            const response = await fetch("{% url 'best_eleven:api_save_formation' %}", {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(dataToSave)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Gagal menyimpan formasi');
            showStatus(result.message || "Formasi berhasil disimpan!", false);
            if (currentFormationId) {
                const index = allHistory.findIndex(f => f.id === currentFormationId);
                if (index > -1) allHistory[index] = result.formation;
            } else {
                allHistory.unshift(result.formation);
                currentFormationId = result.formation.id;
            }
            renderHistoryList();
            highlightCurrentHistoryItem();
        } catch (error) {
            console.error("Error saveFormation:", error);
            alert(`Error: ${error.message}.`);
            showStatus(`Error: ${error.message}.`, true);
        } finally {
            checkFormCompletion();
        }
    }
    async function loadFormation(formationId) { /* ... SAMA ... */
        showStatus("Memuat formasi...", true);
        try {
            const url = `/best-eleven/api/formation/${formationId}/`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Gagal memuat formasi (Error: ${response.statusText})`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            currentSquad = []; 
            selectedPlayers = []; 
            currentFormationId = data.id;
            currentLayout = data.layout;
            formationNameInput.value = data.name;
            formationLayoutSelect.value = data.layout;

            currentSquad = data.players.map(p => ({
                player: p,
                originalSlotId: p.slotId 
            }));

            reAssignPlayersToPitch(); 
            checkFormCompletion();
            showStatus(`Formasi "${data.name}" dimuat.`, false);
            highlightCurrentHistoryItem();

        } catch (error) {
            console.error("Error loadFormation:", error);
            alert(`Error: ${error.message}. (Pastikan API kirim 'slotId'!).`);
            showStatus(`Error: ${error.message}.`, true);
            clearFormation(false, true); 
            currentLayout = '4-3-3';
            formationLayoutSelect.value = '4-3-3';
            reAssignPlayersToPitch(); 
            checkFormCompletion();
        }
    }
    function reAssignPlayersToPitch() { /* ... SAMA ... */
        const newSlots = formationLayouts[currentLayout];
        let availableOldSquad = [...currentSquad]; 
        let newSelectedPlayers = []; 
        let newSquad = []; 
        let unplacedPlayers = []; 

        newSlots.forEach(newSlotId => {
            const requiredRole = slotPositionMap[newSlotId];
            let placed = false;

            const exactMatchIndex = availableOldSquad.findIndex(s =>
                s.originalSlotId === newSlotId &&
                indonesianToRoleMap[s.player.position]?.includes(requiredRole)
            );
            if (exactMatchIndex > -1) {
                const squadMember = availableOldSquad.splice(exactMatchIndex, 1)[0];
                newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
                newSquad.push(squadMember); 
                placed = true;
            }

            if (!placed) {
                const primaryRoleMatchIndex = availableOldSquad.findIndex(s =>
                    indonesianToRoleMap[s.player.position]?.[0] === requiredRole
                );
                if (primaryRoleMatchIndex > -1) {
                     const squadMember = availableOldSquad.splice(primaryRoleMatchIndex, 1)[0];
                     newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
                     newSquad.push({ player: squadMember.player, originalSlotId: newSlotId });
                     placed = true;
                }
            }
             if (!placed) {
                 const secondaryRoleMatchIndex = availableOldSquad.findIndex(s =>
                     indonesianToRoleMap[s.player.position]?.includes(requiredRole)
                 );
                 if (secondaryRoleMatchIndex > -1) {
                     const squadMember = availableOldSquad.splice(secondaryRoleMatchIndex, 1)[0];
                     newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
                     newSquad.push({ player: squadMember.player, originalSlotId: newSlotId });
                     placed = true;
                 }
             }
        });
        unplacedPlayers = availableOldSquad.map(s => s.player);
        currentSquad = newSquad; 
        selectedPlayers = newSelectedPlayers; 
        renderPitchSlots();     
        renderPlayerList();     
        checkFormCompletion();  
        if (unplacedPlayers.length > 0) {
            const names = unplacedPlayers.map(p => p.name || 'Unknown').join(', ');
            showStatus(`Pemain dilepas karena posisi tidak tersedia: ${names}. Pilih slot baru!`, true, 8000);
        } else if (currentSquad.length < 11 && currentSquad.length > 0) {
             showStatus(`Layout diubah. Silakan isi ${11-currentSquad.length} slot kosong.`, false, 5000);
        } else if (currentSquad.length === 0 && availableOldSquad.length > 0) {
             showStatus(`Semua pemain dilepas karena tidak cocok dengan layout baru. Silakan pilih ulang.`, true, 8000);
        }
    }

    // --- renderPitchSlots: PERBARUI CLASS NAMES DENGAN TAILWIND ---
    function renderPitchSlots() {
        pitch.innerHTML = '';
        // Tambahkan class layout dinamis untuk CSS Grid Area
        pitch.className = `relative w-full bg-cover bg-center rounded-lg grid grid-rows-5 grid-cols-5 py-2 h-[450px] md:h-[550px] shadow-inner layout-${currentLayout}`;
        pitch.style.backgroundImage = `url('{% static 'images/lapangan.jpg' %}')`; // Pastikan background tetap ada

        const slots = formationLayouts[currentLayout];
        slots.forEach(slotId => {
            const playerInSlot = selectedPlayers.find(p => p.slotId === slotId);
            const slotEl = document.createElement('div');
            slotEl.id = `slot-${slotId}`;
            // Base slot classes + grid area class
            slotEl.className = `flex flex-col items-center justify-center cursor-pointer transition-all duration-300 group ${slotId}`; // Tambah 'group'
            slotEl.dataset.slotId = slotId;

            if (playerInSlot) {
                 const playerName = playerInSlot.player ? playerInSlot.player.name : 'Unknown';
                 const playerImg = playerInSlot.player ? (playerInSlot.player.profile_image_url || 'https://via.placeholder.com/100') : 'https://via.placeholder.com/100';
                slotEl.innerHTML = `
                    <img src="${playerImg}" alt="${playerName}" class="w-16 h-16 md:w-20 md:h-20 rounded-full object-cover border-4 border-purple-600 shadow-md transition-all duration-300 group-hover:scale-115 group-hover:border-pink-500 group-hover:shadow-lg">
                    <div class="mt-2 text-xs font-semibold text-white bg-gradient-to-r from-purple-700 to-pink-700 px-3 py-1 rounded-full max-w-[100px] whitespace-nowrap overflow-hidden text-ellipsis text-center shadow">${playerName}</div>
                `;
                // Tidak perlu class 'filled' lagi, struktur HTML sudah cukup
            } else {
                slotEl.innerHTML = `
                    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-purple-100 border-2 border-dashed border-purple-300 flex items-center justify-center transition-all duration-300 group-hover:bg-purple-200 group-hover:border-pink-500 group-hover:scale-110 group-hover:shadow-lg">
                        <span class="font-bold text-white text-sm md:text-base text-shadow">${slotId}</span>
                    </div>
                    <div class="mt-2 text-xs font-semibold text-white bg-gradient-to-r from-purple-700 to-pink-700 px-3 py-1 rounded-full max-w-[100px] whitespace-nowrap overflow-hidden text-ellipsis text-center shadow opacity-0 group-hover:opacity-100 transition-opacity">(Empty)</div>
                `;
                 // Tidak perlu class 'empty' lagi
            }
            
            // Handle 'selected' state with Tailwind
            if (slotId === selectedSlotId) {
                 // Cari slot-circle jika ada, tambahkan ring & pulse
                 const circle = slotEl.querySelector('.w-16, .w-20'); // Target lingkaran baik filled (img) atau empty (div)
                 if(circle) {
                    circle.classList.add('ring-4', 'ring-pink-500', 'ring-offset-2', 'ring-offset-gray-800', 'animate-pulse');
                 }
                 // Sembunyikan nama jika selected (opsional, tergantung desain)
                 // const nameEl = slotEl.querySelector('.player-name');
                 // if (nameEl) nameEl.classList.add('hidden');
            }

            slotEl.addEventListener('click', () => handleSlotClick(slotId));
            pitch.appendChild(slotEl);
        });
    }
    // --- AKHIR renderPitchSlots ---


    function renderClubSelect() { /* ... SAMA ... */
        clubSelect.innerHTML = '<option value="">All Clubs</option>';
        allClubs.forEach(club => {
            const o = document.createElement('option');
            o.value = club.id;
            o.textContent = club.name || 'Unknown Club';
            clubSelect.appendChild(o);
        });
    }

    // --- renderPlayerList: PERBARUI CLASS NAMES DENGAN TAILWIND ---
    function renderPlayerList() {
        playerListContainer.innerHTML = '';
        let filteredPlayers = [...currentPlayers]; 
        
        if (currentFilterPositionCode) {
            filteredPlayers = filteredPlayers.filter(p => {
                const playerRoles = indonesianToRoleMap[p.position];
                return playerRoles && playerRoles.includes(currentFilterPositionCode);
            });
            filterPositionLabel.textContent = `Filter: ${currentFilterPositionCode}`;
            clearFilterBtn.classList.remove('hidden');
        } else {
            filterPositionLabel.textContent = 'Select club or position';
            clearFilterBtn.classList.add('hidden');
        }

        const squadPlayerIds = currentSquad.map(s => s.player.id); 
        filteredPlayers = filteredPlayers.filter(p => !squadPlayerIds.includes(p.id));

        if (filteredPlayers.length === 0) {
            playerListContainer.innerHTML = '<p class="text-center py-8 text-gray-500 italic">No matching players found.</p>';
            return;
        }
        
        filteredPlayers.forEach(player => {
            const playerEl = document.createElement('div');
            // Tailwind classes for player item
            playerEl.className = "bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-pink-500 rounded-lg p-4 mb-3 cursor-pointer transition-all duration-300 flex items-center justify-between gap-3 hover:border-pink-600 hover:-translate-y-0.5 hover:shadow-md";
            playerEl.dataset.playerId = player.id;
            let formattedValue;
            try {
                const v = parseFloat(player.market_value);
                if (isNaN(v)) throw new Error();
                formattedValue = v >= 1e12 ? (v / 1e12).toFixed(2) + " T" : v >= 1e9 ? (v / 1e9).toFixed(1) + " M" : (v / 1e6).toFixed(1) + " Jt";
            } catch (e) {
                formattedValue = 'N/A';
            }
            const playerName = player.name || 'Unknown Player';
            const playerImg = player.profile_image_url || 'https://via.placeholder.com/100';
            playerEl.innerHTML = `
                <div class="flex items-center gap-3 flex-1 overflow-hidden">
                    <img src="${playerImg}" alt="${playerName}" class="w-12 h-12 rounded-full object-cover border-3 border-purple-600 flex-shrink-0">
                    <div class="overflow-hidden flex-1">
                        <div class="text-purple-900 font-semibold text-sm truncate">${playerName}</div>
                        <div class="text-gray-500 text-xs flex items-center gap-1">
                            <span>${player.nationality || '-'}</span>
                            <span>‚Ä¢</span>
                            <span class="text-green-600 font-semibold">${formattedValue}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-purple-600 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-semibold flex-shrink-0 uppercase">${player.position || 'N/A'}</div>
            `;
            playerEl.addEventListener('click', () => handlePlayerSelect(player.id));
            playerListContainer.appendChild(playerEl);
        });
    }
    // --- AKHIR renderPlayerList ---

    // --- renderHistoryList: PERBARUI CLASS NAMES DENGAN TAILWIND ---
    function renderHistoryList() {
        historyListContainer.innerHTML = '';
        if (allHistory.length === 0) {
            historyListContainer.innerHTML = '<p class="text-center py-8 text-gray-500 italic">No saved formations yet.</p>';
            return;
        }
        allHistory.forEach(formation => {
            const h = document.createElement('div');
            // Tailwind classes for history item
            h.className = "history-item bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-pink-500 rounded-lg p-4 mb-3 cursor-pointer transition-all duration-300 relative overflow-hidden hover:border-pink-600 hover:translate-x-1 hover:shadow-md";
            h.dataset.formationId = formation.id;

            const deleteButton = document.createElement('button');
            // Tailwind classes for delete button
            deleteButton.className = 'absolute top-2 right-2 text-gray-500 hover:text-red-500 hover:bg-red-100 rounded-full p-1 text-xl transition-all duration-200';
            deleteButton.innerHTML = 'üóëÔ∏è';
            deleteButton.title = 'Hapus Formasi';
            
            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                handleDeleteFormation(formation.id, formation.name);
            });
            
            // Inner HTML with Tailwind classes
            h.innerHTML = `
                <h4 class="text-purple-900 text-base font-semibold mb-1 mr-8 truncate">${formation.name || 'Unnamed Formation'}</h4>
                <p class="text-gray-600 text-xs">Layout: ${formation.layout || 'N/A'}</p>
            `;
            h.appendChild(deleteButton); // Append button after setting innerHTML
            
            // Apply highlight styles dynamically
            if (currentFormationId && h.dataset.formationId == currentFormationId) {
                h.classList.add('border-purple-600', 'ring-2', 'ring-purple-300', 'ring-offset-1'); 
            }

            h.addEventListener('click', () => loadFormation(formation.id));
            historyListContainer.appendChild(h);
        });
        // highlightCurrentHistoryItem(); // Highlight logic now inside the loop
    }
    // --- AKHIR renderHistoryList ---

    // --- highlightCurrentHistoryItem: FUNGSI INI TIDAK DIPERLUKAN LAGI ---
    // function highlightCurrentHistoryItem() { /* ... SAMA ... */ } 
    // Logika highlight dipindah ke dalam renderHistoryList

    function handleSlotClick(slotId) { /* ... SAMA ... */
        const playerInSlot = selectedPlayers.find(p => p.slotId === slotId);
        
        if (playerInSlot) {
            selectedPlayers = selectedPlayers.filter(p => p.slotId !== slotId);
            currentSquad = currentSquad.filter(s => s.player.id !== playerInSlot.player.id);
            selectedSlotId = null; 
            currentFilterPositionCode = null; 
            showStatus(`Pemain ${playerInSlot.player ? playerInSlot.player.name : 'Unknown'} dihapus.`);
            renderPitchSlots(); 
            renderPlayerList(); 
        } else {
            if (selectedSlotId === slotId) {
                selectedSlotId = null;
                currentFilterPositionCode = null; 
                showStatus(`Pemilihan slot ${slotId} dibatalkan.`);
            } else {
                selectedSlotId = slotId;
                currentFilterPositionCode = slotPositionMap[slotId]; 
                showStatus(`Memilih pemain untuk ${slotId} (${currentFilterPositionCode || 'N/A'})`);
            }
            renderPitchSlots(); 
            renderPlayerList(); 
        }
        checkFormCompletion();
    }
    function handlePlayerSelect(playerId) { /* ... SAMA ... */
        if (!selectedSlotId) {
            alert("Pilih slot di lapangan dulu!");
            return;
        }
        const player = currentPlayers.find(p => p.id === playerId);
        if (!player) {
              console.error(`Player with ID ${playerId} not found in currentPlayers`);
              return;
        }
        const expectedRole = slotPositionMap[selectedSlotId];
        const playerRoles = indonesianToRoleMap[player.position];
        
        if (!playerRoles || !playerRoles.includes(expectedRole)) {
            alert(`Posisi tidak cocok! Slot ${selectedSlotId} butuh ${expectedRole || 'N/A'}, sedangkan ${player.name || 'Unknown'} adalah ${player.position || 'N/A'}.`);
            return;
        }
        if (currentSquad.find(s => s.player.id === player.id)) {
            alert(`${player.name || 'Unknown'} sudah ada di skuad.`);
            return;
        }
        currentSquad.push({ player: player, originalSlotId: selectedSlotId }); 
        selectedPlayers.push({ player: player, slotId: selectedSlotId });
        showStatus(`${player.name || 'Unknown'} ditambahkan ke slot ${selectedSlotId}.`);
        selectedSlotId = null;
        currentFilterPositionCode = null;
        renderPitchSlots();
        renderPlayerList(); 
        checkFormCompletion();
    }
    function handleLayoutChange(event) { /* ... SAMA ... */
        currentLayout = event.target.value;
        if (selectedSlotId) {
            selectedSlotId = null;
            currentFilterPositionCode = null;
        }
        reAssignPlayersToPitch(); 
    }
    function handleClubChange() { /* ... SAMA ... */
        const clubId = clubSelect.value;
        if (selectedSlotId) {
            selectedSlotId = null;
        }
        currentFilterPositionCode = null; 
        fetchPlayers(clubId); 
        renderPitchSlots(); 
    }
    function handleClearFilter() { /* ... SAMA ... */
        if (selectedSlotId) {
            selectedSlotId = null; 
        }
        currentFilterPositionCode = null; 
        renderPitchSlots(); 
        renderPlayerList();
    }
    function clearFormation(showMsg = true, isCreatingNew = false) { /* ... SAMA ... */
        selectedPlayers = [];
        currentSquad = [];
        selectedSlotId = null;
        currentFilterPositionCode = null;

        if (isCreatingNew) {
              currentFormationId = null;
              formationNameInput.value = '';
              currentLayout = '4-3-3'; 
              formationLayoutSelect.value = '4-3-3';
        }
        reAssignPlayersToPitch(); 
        // highlightCurrentHistoryItem(); // Tidak perlu lagi
        renderHistoryList(); // Render ulang history untuk hapus highlight

        if (showMsg) showStatus("Formasi dibersihkan.", false);
    }
    function checkFormCompletion() { /* ... SAMA ... */
        const isComplete = currentSquad.length === 11 && formationNameInput.value.trim() !== '';
        saveFormationBtn.disabled = !isComplete;
        const remaining = 11 - currentSquad.length; 
        if (isComplete) {
            saveFormationBtn.textContent = currentFormationId ? '‚úÖ Update' : 'üíæ Save Formation';
        } else {
            if (remaining > 0) {
                 saveFormationBtn.textContent = `‚öΩ Pick ${remaining} more`;
            } else if (remaining < 0) {
                 saveFormationBtn.textContent = `‚ö†Ô∏è Too many (${-remaining}) players`;
                 console.error("Squad has more than 11 players:", currentSquad);
            } else { 
                 saveFormationBtn.textContent = '‚úèÔ∏è Add Name';
            }
        }
    }

    // --- showStatus: PERBARUI CLASS NAMES DENGAN TAILWIND ---
    function showStatus(message, isError = false, duration = 4000) {
        console.log(`Status (${isError ? 'Error' : 'Info'}): ${message}`);
        globalStatus.textContent = message;
        // Hapus kelas gaya lama jika ada
        globalStatus.className = 'min-h-[40px] mb-6 transition-all duration-300'; // Reset ke class dasar
        
        // Tambah kelas Tailwind yang sesuai
        if (isError) {
             globalStatus.classList.add('bg-red-100', 'border-2', 'border-red-500', 'text-red-700', 'p-3', 'rounded-md', 'text-center', 'font-semibold');
        } else {
             globalStatus.classList.add('bg-green-100', 'border-2', 'border-green-500', 'text-green-700', 'p-3', 'rounded-md', 'text-center', 'font-semibold');
        }
        
        setTimeout(() => {
            if (globalStatus.textContent === message) { 
                globalStatus.textContent = '';
                globalStatus.className = 'min-h-[40px] mb-6 transition-all duration-300'; 
            }
        }, duration);
    }
    // --- AKHIR showStatus ---

    async function handleDeleteFormation(formationId, formationName) { /* ... SAMA ... */
        if (!confirm(`Yakin ingin menghapus formasi "${formationName}"? Tindakan ini tidak bisa dibatalkan.`)) {
            return;
        }
        showStatus(`Menghapus formasi "${formationName}"...`, true); 
        try {
            const url = `/best-eleven/api/formation/${formationId}/`; 
            const response = await fetch(url, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });

            if (response.status === 204) { 
                allHistory = allHistory.filter(f => f.id !== formationId);
                renderHistoryList();
                if (currentFormationId === formationId) {
                    clearFormation(false, true); 
                    showStatus(`Formasi "${formationName}" berhasil dihapus, builder di-reset.`, false);
                } else {
                    showStatus(`Formasi "${formationName}" berhasil dihapus.`, false);
                }
            } else {
                const result = await response.json();
                throw new Error(result.error || `Gagal menghapus formasi. Status: ${response.status}`);
            }
        } catch (error) {
            console.error("Error handleDeleteFormation:", error);
            showStatus(`Error: ${error.message}.`, true);
        }
    }

    document.addEventListener('DOMContentLoaded', () => { /* ... SAMA ... */
        fetchInitialData();
        clubSelect.addEventListener('change', handleClubChange);
        formationLayoutSelect.addEventListener('change', handleLayoutChange);
        saveFormationBtn.addEventListener('click', saveFormation);
        clearFormationBtn.addEventListener('click', () => {
            clearFormation(true, false); 
        }); 
        newFormationBtn.addEventListener('click', () => {
             clearFormation(true, true);
        }); 
        clearFilterBtn.addEventListener('click', handleClearFilter);
        formationNameInput.addEventListener('input', checkFormCompletion);
        window.addEventListener('resize', renderPitchSlots);
    });
</script>
{% endblock content %}