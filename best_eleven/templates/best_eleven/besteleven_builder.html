{% extends "base.html" %}
{% load static %}

{% block title %}Best XI Team Builder{% endblock title %}

{% block content %}

<style>
    h1,
    h2 {
        color: #EDF2F7;
        /* text-gray-100 - Lebih Putih */
    }

    h1.text-indigo-900 {
        /* Override judul utama */
        color: #041424 !important;
    }

    label,
    .text-sm {
        color: #CBD5E0;
        /* text-gray-300 - Lebih Terang */
    }

    /* Default text color - Lebih Terang */
    .sidebar-column,
    .sidebar-column *,
    /* Ganti .lg\:col-span-1 */
    #player-list p,
    #history-list p,
    select,
    input {
        color: #EDF2F7;
        /* text-gray-100 - Lebih Putih */
    }

    /* [KIRI & KANAN] Kolom samping (Sidebar) */
    .sidebar-column {
        /* Ganti .lg\:col-span-1 */
        background-color: #1A202C;
        /* bg-gray-900 */
        border: 1px solid #4A5568;
        /* border-gray-700 */
        border-radius: 0.75rem;
        /* rounded-xl */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        /* shadow-lg */
        display: flex;
        flex-direction: column;
        padding: 1.25rem;
        /* p-5 */
    }

    .sidebar-column h2 {
        /* Judul kolom */
        color: #EDF2F7 !important;
        border-bottom: 1px solid #4A5568 !important;
        /* border-b */
        margin-bottom: 1rem;
        /* mb-4 */
        padding-bottom: 0.5rem;
        /* pb-2 */
        font-size: 1.25rem;
        /* text-xl */
        font-weight: 600;
        /* font-semibold */
    }

    /* Pastikan list di kiri/kanan bisa scroll */
    #history-list,
    #player-list {
        overflow-y: auto;
        flex-grow: 1;
        /* Agar list mengisi sisa ruang */
        /* max-height diset di HTML inline style */
    }


    /* [TENGAH] Lapangan */
    .pitch-column {
        /* Ganti .lg\:col-span-2 */
        background-color: #1A361A;
        /* Hijau gelap fallback */
        border: 1px solid #2F4D2F;
        border-radius: 0.75rem;
        /* rounded-xl */
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        /* shadow-inner */
        padding: 1rem;
        /* p-4 */
        /* Background Image Dipasang Langsung Di Sini */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    /* [KIRI] History Item */
    #history-list .history-item {
        /* Tambah class */
        background-color: #2D3748;
        /* bg-gray-800 */
        border: 1px solid #4A5568;
        /* border */
        border-radius: 0.5rem;
        /* rounded-lg */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        /* shadow-sm */
        cursor: pointer;
        padding: 0.75rem;
        /* p-3 */
    }

    #history-list .history-item:hover {
        background-color: #4A5568;
        /* bg-gray-700 */
    }

    #history-list h4 {
        color: #BEE3F8;
        /* text-blue-200 - Lebih terang */
        font-weight: 600;
        /* font-semibold */
    }

    #history-list p {
        /* Layout text */
        color: #CBD5E0;
        /* text-gray-300 */
    }

    #history-list .history-item.highlighted {
        /* Ganti .bg-indigo-100 */
        background-color: #4C51BF !important;
        /* Indigo yang lebih kuat */
        border-color: #A3BFFA !important;
        box-shadow: 0 0 0 2px #A3BFFA;
        /* ring-2 */
    }

    #history-list .text-gray-500 {
        /* 'Loading/Empty' text */
        color: #A0AEC0;
    }


    /* [KANAN] Dropdown & Input */
    #club-select,
    #formation-layout-select,
    #formation-name {
        background-color: #2D3748;
        /* bg-gray-800 */
        color: #EDF2F7;
        /* Lebih putih */
        border: 1px solid #718096;
        /* border + Border lebih terang */
        border-radius: 0.375rem;
        /* rounded-md */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        /* shadow-sm */
        padding: 0.5rem 0.75rem;
        /* py-2 px-3 */
        width: 100%;
        /* Pastikan full width */
    }

    #club-select option {
        background-color: #2D3748;
        color: #EDF2F7;
    }

    #filter-position-label {
        color: #BEE3F8 !important;
        /* text-blue-200 */
        font-weight: 500;
        /* font-medium */
    }

    label[for="club-select"] {
        color: #CBD5E0 !important;
        /* text-gray-300 */
        font-weight: 500;
        /* font-medium */
        margin-bottom: 0.25rem;
        /* mb-1 */
        display: block;
        /* Agar label di atas select */
    }


    /* [KANAN] Player Item */
    #player-list .player-item {
        /* Tambah class */
        background-color: #2D3748;
        /* bg-gray-800 */
        border: 1px solid #4A5568;
        /* border */
        border-radius: 0.5rem;
        /* rounded-lg */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        /* shadow-sm */
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        /* p-3 */
        cursor: pointer;
    }

    #player-list .player-item:hover {
        background-color: #4A5568;
        /* bg-gray-700 */
        transform: scale(1.02);
    }

    #player-list .font-bold {
        /* Nama Pemain */
        color: #EDF2F7 !important;
        /* text-gray-100 */
        font-weight: 600;
        /* font-semibold */
    }

    #player-list .text-sm {
        /* Negara & Value Wrapper */
        color: #CBD5E0 !important;
        /* text-gray-300 */
    }

    #player-list span.font-medium {
        /* Market Value */
        color: #9AE6B4 !important;
        /* text-green-300 - Lebih terang */
        font-weight: 600;
        /* font-semibold */
    }

    #player-list .player-position-badge {
        /* Ganti .bg-gray-200 etc */
        background-color: #4A5568 !important;
        /* bg-gray-700 */
        color: #EDF2F7 !important;
        /* Lebih putih */
        font-weight: 600;
        /* font-semibold */
        border-radius: 0.375rem;
        /* rounded-md */
        padding: 0.125rem 0.5rem;
        /* px-2 py-1 */
        font-size: 0.875rem;
        /* text-sm */
        flex-shrink: 0;
        /* Agar tidak mengecil */
    }

    #player-list .text-gray-500,
    /* 'Loading/No players' text */
    #player-list p.p-4 {
        color: #A0AEC0;
    }


    /* [TENGAH] Lapangan & Slot Pemain */
    .pitch-slot {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border-radius: 9999px;
    }

    .pitch-slot .player-name {
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 1px 6px;
        border-radius: 8px;
        margin-top: 3px;
        text-align: center;
        max-width: 90px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .pitch-slot.empty:hover {
        transform: scale(1.1);
    }

    .pitch-slot.filled:hover img {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(255, 255, 100, 0.7);
    }

    .pitch-slot.selected {
        animation: pulse 1.5s infinite;
    }

    .pitch-slot.selected .player-name {
        display: none;
    }

    .pitch-slot.selected div:first-child {
        background-color: rgba(255, 255, 100, 0.3);
        border-color: rgba(255, 255, 100, 0.7);
        border-style: solid;
        /* Tambah border-style */
    }

    .pitch-slot.empty span {
        /* Tulisan GK, LB di slot kosong */
        font-weight: 700;
        /* font-bold */
        color: white;
        font-size: 1.125rem;
        /* text-lg */
        line-height: 1;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }

    /* POSISI SLOT PEMAIN (GRID) */
    #pitch {
        display: grid;
        grid-template-rows: repeat(5, 1fr);
        grid-template-columns: repeat(5, 1fr);
        padding: 10px 0;
        /* Kurangi padding atas bawah */
        transition: all 0.3s ease;
        /* UKURAN LAPANGAN DIKECILKAN DI SINI */
        height: 450px;
        /* Tinggi dasar */
        position: relative;
        /* Tambahkan ini agar slot tidak keluar */
        width: 100%;
        /* Pastikan lebar penuh */
    }

    /* Responsif ukuran lapangan */
    @media (min-width: 768px) {

        /* md */
        #pitch {
            height: 550px;
        }
    }

    /* Posisi Grid Area */
    .GK {
        grid-area: 5 / 3 / 6 / 4;
    }

    .LB {
        grid-area: 4 / 1 / 5 / 2;
    }

    .LCB {
        grid-area: 4 / 2 / 5 / 3;
    }

    .RCB {
        grid-area: 4 / 4 / 5 / 5;
    }

    .RB {
        grid-area: 4 / 5 / 5 / 6;
    }

    .layout-4-3-3 .LCM {
        grid-area: 3 / 2 / 4 / 3;
    }

    .layout-4-3-3 .CM {
        grid-area: 3 / 3 / 4 / 4;
    }

    .layout-4-3-3 .RCM {
        grid-area: 3 / 4 / 4 / 5;
    }

    .layout-4-3-3 .LW {
        grid-area: 2 / 1 / 3 / 2;
    }

    .layout-4-3-3 .ST {
        grid-area: 2 / 3 / 3 / 4;
    }

    .layout-4-3-3 .RW {
        grid-area: 2 / 5 / 3 / 6;
    }

    .layout-4-4-2 .LM {
        grid-area: 3 / 1 / 4 / 2;
    }

    .layout-4-4-2 .LCM {
        grid-area: 3 / 2 / 4 / 3;
    }

    .layout-4-4-2 .RCM {
        grid-area: 3 / 4 / 4 / 5;
    }

    .layout-4-4-2 .RM {
        grid-area: 3 / 5 / 4 / 6;
    }

    .layout-4-4-2 .LST {
        grid-area: 2 / 2 / 3 / 3;
    }

    .layout-4-4-2 .RST {
        grid-area: 2 / 4 / 3 / 5;
    }

    .layout-3-5-2 .LCB {
        grid-area: 4 / 2 / 5 / 3;
    }

    .layout-3-5-2 .CB {
        grid-area: 4 / 3 / 5 / 4;
    }

    .layout-3-5-2 .RCB {
        grid-area: 4 / 4 / 5 / 5;
    }

    .layout-3-5-2 .LWB {
        grid-area: 3 / 1 / 4 / 2;
    }

    .layout-3-5-2 .LCM {
        grid-area: 3 / 2 / 4 / 3;
    }

    .layout-3-5-2 .CAM {
        grid-area: 3 / 3 / 4 / 4;
    }

    .layout-3-5-2 .RCM {
        grid-area: 3 / 4 / 4 / 5;
    }

    .layout-3-5-2 .RWB {
        grid-area: 3 / 5 / 4 / 6;
    }

    .layout-3-5-2 .LST {
        grid-area: 2 / 2 / 3 / 3;
    }

    .layout-3-5-2 .RST {
        grid-area: 2 / 4 / 3 / 5;
    }

    .layout-4-2-3-1 .LDM {
        grid-area: 3 / 2 / 4 / 3;
    }

    .layout-4-2-3-1 .RDM {
        grid-area: 3 / 4 / 4 / 5;
    }

    .layout-4-2-3-1 .LAM {
        grid-area: 2 / 1 / 3 / 2;
    }

    .layout-4-2-3-1 .CAM {
        grid-area: 2 / 3 / 3 / 4;
    }

    .layout-4-2-3-1 .RAM {
        grid-area: 2 / 5 / 3 / 6;
    }

    .layout-4-2-3-1 .ST {
        grid-area: 1 / 3 / 2 / 4;
    }

    /* Status Message Colors (Dark Mode) */
    .bg-red-900\/50 {
        background-color: rgba(155, 44, 44, 0.7);
    }

    /* Red Lebih Pekat */
    .text-red-300 {
        color: #FEB2B2;
    }

    /* Merah Muda Terang */
    .bg-green-900\/50 {
        background-color: rgba(30, 77, 43, 0.7);
    }

    /* Green Lebih Pekat */
    .text-green-300 {
        color: #C6F6D5;
    }

    /* Hijau Muda Terang */

    /* Tombol */
    button {
        transition: background-color 0.2s ease;
    }

    .text-red-400 {
        color: #FC8181;
    }

    /* Warna tombol clear filter */
    .hover\:text-red-600:hover {
        color: #E53E3E;
    }

    /* Utility */
    .space-y-3>:not([hidden])~:not([hidden]) {
        margin-top: 0.75rem;
    }

    .mb-4 {
        margin-bottom: 1rem;
    }

    .mb-8 {
        margin-bottom: 2rem;
    }

    .text-center {
        text-align: center;
    }

    .min-h-\[40px\] {
        min-height: 40px;
    }

    .font-semibold {
        font-weight: 600;
    }

    .p-2 {
        padding: 0.5rem;
    }

    .rounded-md {
        border-radius: 0.375rem;
    }

    .gap-6 {
        gap: 1.5rem;
    }

    .border-b {
        border-bottom-width: 1px;
    }

    .pb-2 {
        padding-bottom: 0.5rem;
    }

    .mb-1 {
        margin-bottom: 0.25rem;
    }

    .mb-2 {
        margin-bottom: 0.5rem;
    }

    .hidden {
        display: none;
    }

    .items-center {
        align-items: center;
    }

    .justify-between {
        justify-content: space-between;
    }

    .mt-4 {
        margin-top: 1rem;
    }

    .font-bold {
        font-weight: 700;
    }

    .font-extrabold {
        font-weight: 800;
    }

    .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }

    .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .px-5 {
        padding-left: 1.25rem;
        padding-right: 1.25rem;
    }

    .rounded-lg {
        border-radius: 0.5rem;
    }

    .shadow-md {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .opacity-50 {
        opacity: 0.5;
    }

    .cursor-not-allowed {
        cursor: not-allowed;
    }

    .transform {
        /* Enable transforms */
    }

    .hover\:scale-105:hover {
        transform: scale(1.05);
    }

    .bg-red-600 {
        background-color: #E53E3E;
    }

    .hover\:bg-red-700:hover {
        background-color: #C53030;
    }

    .bg-indigo-600 {
        background-color: #5A67D8;
    }

    .hover\:bg-indigo-700:hover {
        background-color: #4C51BF;
    }

    .text-white {
        color: #FFFFFF;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    .hover\:text-red-800:hover {
        color: #9B2C2C;
    }

    .tracking-tight {
        letter-spacing: -0.025em;
    }

    /* Responsive Grid */
    @media (min-width: 1024px) {

        /* lg */
        .lg\:grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .lg\:col-span-1 {
            grid-column: span 1 / span 1;
        }

        .lg\:col-span-2 {
            grid-column: span 2 / span 2;
        }
    }

    @media (min-width: 768px) {

        /* md */
        .md\:flex-row {
            flex-direction: row;
        }

        .md\:w-auto {
            width: auto;
        }

        .md\:w-16 {
            width: 4rem;
        }

        .md\:h-16 {
            height: 4rem;
        }

        .md\:text-xl {
            font-size: 1.25rem;
        }
    }

    .w-full {
        width: 100%;
    }

    .flex-grow {
        flex-grow: 1;
    }

    .w-12 {
        width: 3rem;
    }

    .h-12 {
        height: 3rem;
    }

    .rounded-full {
        border-radius: 9999px;
    }

    .object-cover {
        object-fit: cover;
    }

    .border-4 {
        border-width: 4px;
    }

    .border-white {
        border-color: #FFFFFF;
    }

    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .bg-black\/20 {
        background-color: rgba(0, 0, 0, 0.2);
    }

    .bg-black\/30 {
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* Untuk kontrol formasi */
    .backdrop-blur-sm {
        backdrop-filter: blur(4px);
    }

    /* Blur di kontrol formasi */
    .border-dashed {
        border-style: dashed;
    }

    .border-white\/50 {
        border-color: rgba(255, 255, 255, 0.5);
    }

    .flex {
        display: flex;
    }

    .text-lg {
        font-size: 1.125rem;
    }

    .space-x-3>:not([hidden])~:not([hidden]) {
        margin-left: 0.75rem;
    }

    .overflow-hidden {
        overflow: hidden;
    }

    .border-indigo-400 {
        border-color: #A3BFFA;
    }

    .border-2 {
        border-width: 2px;
    }

    .flex-shrink-0 {
        flex-shrink: 0;
    }

    .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .relative {
        position: relative;
    }

    .pt-4 {
        padding-top: 1rem;
    }

    .border-t {
        border-top-width: 1px;
    }

    .border-gray-700 {
        border-color: #4A5568;
    }
</style>

<div class="container mx-auto px-4 py-6">
    <h1 class="text-4xl font-extrabold text-indigo-900 mb-8 text-center tracking-tight">
        Best XI Team Builder ⚽️
    </h1>

    <div id="global-status" class="mb-4 text-center min-h-[40px]"></div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <div class="lg:col-span-1 sidebar-column">
            <h2>Saved Formations 💾</h2>
            <div id="history-list" class="space-y-3" style="max-height: calc(80vh - 100px);">
                <p class="italic text-sm p-4 text-center">Loading history...</p>
            </div>
        </div>

        <div class="lg:col-span-2 pitch-column" style="background-image: url('{% static 'images/lapangan.jpg' %}')">

            <div class="flex flex-col md:flex-row gap-4 mb-4 p-2 bg-black/40 rounded-lg backdrop-blur-sm">
                <input type="text" id="formation-name" placeholder="Nama Formasi (Misal: Tim Impian)" class="flex-grow w-full px-4 py-2 border focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <select id="formation-layout-select" class="w-full md:w-auto px-4 py-2 border focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <option value="4-3-3">4-3-3</option>
                    <option value="4-4-2">4-4-2</option>
                    <option value="3-5-2">3-5-2</option>
                    <option value="4-2-3-1">4-2-3-1</option>
                </select>
            </div>

            <div id="pitch" class="relative w-full">
                {/* Hapus kelas tinggi dari sini */}
                {/* Slots akan di-render oleh JavaScript */}
            </div>

            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                <button id="clear-formation-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    Clear
                </button>
                <button id="save-formation-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed" disabled>
                    Simpan Formasi
                </button>
            </div>
        </div>

        <div class="lg:col-span-1 sidebar-column">
            <h2>Player List 📋</h2>
            <div class="mb-4">
                <label for="club-select">Filter by Club</label>
                <select id="club-select" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Loading clubs...</option>
                </select>
            </div>
            <div class="flex justify-between items-center mb-2">
                <span id="filter-position-label" class="text-sm font-medium">Pilih Klub (atau slot)</span>
                <button id="clear-filter-btn" class="text-xs text-red-400 hover:text-red-600 hidden">&times; Hapus Filter Posisi</button>
            </div>

            <div id="player-list" class="space-y-3" style="max-height: calc(80vh - 200px);">
                <p class="italic text-sm p-4 text-center">Loading players...</p>
            </div>
        </div>

    </div>
</div>

<script>
    // --- Global State ---
    let allClubs = [];
    let allHistory = [];
    let currentPlayers = [];
    
    // --- PERUBAHAN STATE UTAMA ---
    let currentSquad = []; 
    let selectedPlayers = []; 
    let selectedSlotId = null;
    let currentFilterPositionCode = null; 
    let currentLayout = '4-3-3'; 
    let currentFormationId = null; 

    // --- Element Selectors ---
    const pitch = document.getElementById('pitch');
    const clubSelect = document.getElementById('club-select');
    const formationLayoutSelect = document.getElementById('formation-layout-select');
    const formationNameInput = document.getElementById('formation-name');
    const playerListContainer = document.getElementById('player-list');
    const historyListContainer = document.getElementById('history-list');
    const saveFormationBtn = document.getElementById('save-formation-btn');
    const clearFormationBtn = document.getElementById('clear-formation-btn');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const globalStatus = document.getElementById('global-status');
    const filterPositionLabel = document.getElementById('filter-position-label');

    // --- Layout Definitions ---
    const formationLayouts = {
        '4-3-3': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LCM', 'CM', 'RCM', 'LW', 'ST', 'RW'],
        '4-4-2': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LM', 'LCM', 'RCM', 'RM', 'LST', 'RST'],
        '3-5-2': ['GK', 'LCB', 'CB', 'RCB', 'LWB', 'LCM', 'RCM', 'RWB', 'CAM', 'LST', 'RST'],
        '4-2-3-1': ['GK', 'LB', 'LCB', 'RCB', 'RB', 'LDM', 'RDM', 'LAM', 'CAM', 'RAM', 'ST']
    };

    // KAMUS 1: Slot Lapangan -> Peran yang Dibutuhkan
    const slotPositionMap = {
        'GK': 'Kiper',
        'LB': 'Bek-Kiri', 'LWB': 'Bek-Kiri',
        'LCB': 'Bek-Tengah', 'CB': 'Bek-Tengah', 'RCB': 'Bek-Tengah',
        'RB': 'Bek-Kanan', 'RWB': 'Bek-Kanan',
        'LDM': 'Gel. Bertahan', 'RDM': 'Gel. Bertahan',
        'LM': 'Sayap Kiri', 'LCM': 'Gel. Tengah', 'CM': 'Gel. Tengah', 'RCM': 'Gel. Tengah', 'RM': 'Sayap Kanan',
        'LAM': 'Sayap Kiri', 'CAM': 'Gel. Serang', 'RAM': 'Sayap Kanan',
        'LW': 'Sayap Kiri', 'RW': 'Sayap Kanan',
        'LST': 'Penyerang', 'ST': 'Penyerang', 'RST': 'Penyerang'
    };

    // KAMUS 2: Posisi Pemain -> Daftar Peran [Array] yang BISA DIA ISI
    const indonesianToRoleMap = {
        'Kiper': ['Kiper'],
        'Bek-Tengah': ['Bek-Tengah'],
        'Bek-Kanan': ['Bek-Kanan'],
        'Bek-Kiri': ['Bek-Kiri'],
        'Gel. Bertahan': ['Gel. Bertahan', 'Gel. Tengah'],
        'Gel. Serang': ['Gel. Serang', 'Gel. Tengah', 'Sayap Kiri', 'Sayap Kanan'],
        'Gel. Tengah': ['Gel. Tengah', 'Gel. Bertahan', 'Gel. Serang'],
        'Sayap Kiri': ['Sayap Kiri', 'Gel. Serang', 'Bek-Kiri'],
        'Sayap Kanan': ['Sayap Kanan', 'Gel. Serang', 'Bek-Kanan'],
        'Penyerang': ['Penyerang'],
        'Depan-Tengah': ['Penyerang']
    };

    // --- Helper CSRF ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- AJAX Functions ---
    // fetchInitialData & fetchPlayers tidak berubah
    async function fetchInitialData() {
        showStatus("Mengambil data klub & histori...", true);
        try {
            const response = await fetch("{% url 'best_eleven:api_builder_data' %}");
            if (!response.ok) throw new Error(`Gagal memuat data awal. (Error: ${response.status})`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            allClubs = data.clubs;
            allHistory = data.history;
            renderClubSelect();
            renderHistoryList();
            await fetchPlayers();
            // Panggil reAssignPlayersToPitch setelah data siap, untuk inisialisasi awal
            reAssignPlayersToPitch(); 
            showStatus("Siap! Pilih slot di lapangan.", false, 3000);
        } catch (error) {
            console.error("Error fetchInitialData:", error);
            showStatus(`Error: ${error.message}. (Mungkin belum login?)`, true);
        }
    }

    async function fetchPlayers(clubId = null) {
        showStatus("Mengambil data pemain...", true);
        try {
            let url = "{% url 'best_eleven:api_get_players' %}";
            if (clubId) {
                url += `?club_id=${clubId}`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Gagal memuat pemain. (Error: ${response.status})`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            currentPlayers = data.players;
            renderPlayerList(); // Render ulang daftar pemain di kanan
            showStatus("Daftar pemain diperbarui.", false, 2000);
        } catch (error) {
            console.error("Error fetchPlayers:", error);
            showStatus(`Error: ${error.message}.`, true);
        }
    }

    // saveFormation: Menyimpan MASTER SQUAD (currentSquad)
    async function saveFormation() {
        const formationName = formationNameInput.value.trim();
        if (currentSquad.length !== 11 || !formationName) {
            showStatus("Nama formasi harus diisi dan pemain harus 11.", true);
            return;
        }
        showStatus("Menyimpan formasi...", true);
        saveFormationBtn.disabled = true;
        const dataToSave = {
            name: formationName,
            layout: currentLayout, 
            formation_id: currentFormationId,
            player_ids: currentSquad.map(s => ({
                slotId: s.originalSlotId, 
                playerId: s.player.id
            }))
        };
        try {
            const response = await fetch("{% url 'best_eleven:api_save_formation' %}", {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(dataToSave)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Gagal menyimpan');
            showStatus(result.message || "Formasi berhasil disimpan!", false, 3000);
            if (currentFormationId) { // Update history jika ini update
                const index = allHistory.findIndex(f => f.id === currentFormationId);
                if (index > -1) allHistory[index] = result.formation;
            } else {
                allHistory.unshift(result.formation);
                currentFormationId = result.formation.id; 
            }
            renderHistoryList();
            highlightCurrentHistoryItem(); 
        } catch (error) {
            console.error("Error saveFormation:", error);
            showStatus(`Error: ${error.message}.`, true);
        } finally {
            checkFormCompletion(); // Re-enable tombol save
        }
    }

    // loadFormation: Memuat ke MASTER SQUAD (currentSquad) lalu memanggil reAssign
    async function loadFormation(formationId) {
        showStatus("Memuat formasi...", true);
        try {
            const url = `/best-eleven/api/formation/${formationId}/`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Gagal memuat formasi: ${response.statusText}`);
            const data = await response.json(); 
            if (data.error) throw new Error(data.error);

            // 1. Reset state dulu (tapi JANGAN panggil clearFormation karena itu reset layout)
            currentSquad = [];
            selectedPlayers = [];
            currentFormationId = data.id;
            currentLayout = data.layout; // Set layout sesuai yg di-load
            formationNameInput.value = data.name;
            formationLayoutSelect.value = data.layout;

            // 2. Isi MASTER SQUAD (currentSquad) dari data yg di-load
            currentSquad = data.players.map(p => ({
                player: p, 
                originalSlotId: p.slotId 
            }));

            // 3. Panggil fungsi pintar untuk menempatkan pemain ke lapangan
            reAssignPlayersToPitch();

            // 4. Update UI lainnya
            await fetchPlayers(clubSelect.value); // Ambil data pemain (jika perlu update)
            renderPlayerList();
            checkFormCompletion();
            showStatus(`Formasi "${data.name}" dimuat.`, false, 3000);
            highlightCurrentHistoryItem();

        } catch (error) {
            console.error("Error loadFormation:", error);
            showStatus(`Error: ${error.message}. (Pastikan API kirim 'slotId'!).`, true);
            // Jika error, reset ke state awal yg bersih
            clearFormation(false);
            currentLayout = '4-3-3'; // Reset layout
            formationLayoutSelect.value = '4-3-3';
            reAssignPlayersToPitch(); // Coba assign ulang (mungkin jadi kosong)
            checkFormCompletion();
        }
    }

    // --- FUNGSI BARU (INTI LOGIKA) ---
    // Menempatkan pemain dari `currentSquad` ke `selectedPlayers` sesuai `currentLayout`
    function reAssignPlayersToPitch() {
        const newSlots = formationLayouts[currentLayout];
        let unassignedSquadMembers = [...currentSquad]; // Copy dari master
        let newSelectedPlayers = []; // Hasil penempatan di lapangan

        // --- LOGIKA "BEST-FIT" DENGAN 3 PUTARAN ---
        let remainingNewSlots = []; // Slot yg belum terisi

        // PUTARAN 1: "PULANG KAMPUNG" (Slot asli = slot baru)
        newSlots.forEach(newSlotId => {
            const playerIndex = unassignedSquadMembers.findIndex(s => s.originalSlotId === newSlotId);
            if (playerIndex > -1) {
                const squadMember = unassignedSquadMembers.splice(playerIndex, 1)[0];
                newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
            } else {
                remainingNewSlots.push(newSlotId);
            }
        });

        // PUTARAN 2: "PERAN UTAMA" (Peran[0] cocok)
        let remainingNewSlots2 = [];
        remainingNewSlots.forEach(newSlotId => {
            const requiredRole = slotPositionMap[newSlotId];
            if (!requiredRole) return;
            const playerIndex = unassignedSquadMembers.findIndex(s => {
                const playerRoles = indonesianToRoleMap[s.player.position];
                return playerRoles && playerRoles[0] === requiredRole;
            });
            if (playerIndex > -1) {
                const squadMember = unassignedSquadMembers.splice(playerIndex, 1)[0];
                newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
            } else {
                remainingNewSlots2.push(newSlotId);
            }
        });

        // PUTARAN 3: "PERAN SEKUNDER" (.includes() cocok)
        remainingNewSlots2.forEach(newSlotId => {
            const requiredRole = slotPositionMap[newSlotId];
            if (!requiredRole) return;
            const playerIndex = unassignedSquadMembers.findIndex(s => {
                const playerRoles = indonesianToRoleMap[s.player.position];
                return playerRoles && playerRoles.includes(requiredRole);
            });
            if (playerIndex > -1) {
                const squadMember = unassignedSquadMembers.splice(playerIndex, 1)[0];
                newSelectedPlayers.push({ player: squadMember.player, slotId: newSlotId });
            }
        });
        // --- AKHIR LOGIKA 3-PUTARAN ---

        selectedPlayers = newSelectedPlayers; // Update pemain di lapangan
        renderPitchSlots(); // Gambar ulang lapangan
    }

    // --- RENDER Functions ---
    // renderPitchSlots & renderPlayerList tidak perlu diubah lagi
    function renderPitchSlots() {
        pitch.innerHTML = '';
        pitch.className = `relative w-full layout-${currentLayout}`;
        pitch.style.height = '450px'; if (window.innerWidth >= 768) { pitch.style.height = '550px'; }
        const slots = formationLayouts[currentLayout];
        slots.forEach(slotId => {
            const slotEl = document.createElement('div');
            slotEl.id = `slot-${slotId}`; slotEl.className = `pitch-slot ${slotId}`; slotEl.dataset.slotId = slotId;
            const playerInSlot = selectedPlayers.find(p => p.slotId === slotId); // Cari di pemain lapangan
            if (playerInSlot) {
                slotEl.innerHTML = `<img src="${playerInSlot.player.profile_image_url || 'https://via.placeholder.com/100'}" alt="${playerInSlot.player.name}" class="w-12 h-12 md:w-16 md:h-16 rounded-full object-cover border-4 border-white shadow-lg"><div class="player-name">${playerInSlot.player.name}</div>`;
                slotEl.classList.add('filled');
            } else {
                slotEl.innerHTML = `<div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-black/20 border-4 border-dashed border-white/50 flex items-center justify-center"><span class="font-bold text-white text-lg md:text-xl">${slotId}</span></div><div class="player-name">(Kosong)</div>`;
                slotEl.classList.add('empty');
            }
            if (slotId === selectedSlotId) slotEl.classList.add('selected');
            slotEl.addEventListener('click', () => handleSlotClick(slotId));
            pitch.appendChild(slotEl);
        });
    }

    function renderPlayerList() {
        playerListContainer.innerHTML = '';
        let filteredPlayers = [...currentPlayers];
        if (currentFilterPositionCode) {
            filteredPlayers = filteredPlayers.filter(p => {
                const playerRoles = indonesianToRoleMap[p.position]; return playerRoles && playerRoles.includes(currentFilterPositionCode);
            });
            filterPositionLabel.textContent = `Filter: ${currentFilterPositionCode}`; clearFilterBtn.classList.remove('hidden');
        } else {
            filterPositionLabel.textContent = 'Pilih Klub (atau slot)'; clearFilterBtn.classList.add('hidden');
        }
        const selectedPlayerIds = selectedPlayers.map(p => p.player.id); // Filter yg sudah DI LAPANGAN
        filteredPlayers = filteredPlayers.filter(p => !selectedPlayerIds.includes(p.id));
        if (filteredPlayers.length === 0) { playerListContainer.innerHTML = '<p class="p-4 text-center">Tidak ada pemain yang cocok.</p>'; return; }
        filteredPlayers.forEach(player => {
            const playerEl = document.createElement('div'); playerEl.className = "player-item"; playerEl.dataset.playerId = player.id;
            let formattedValue; try { const v = parseFloat(player.market_value); if (isNaN(v)) throw new Error(); formattedValue = v >= 1e12 ? (v / 1e12).toFixed(2) + " T" : v >= 1e9 ? (v / 1e9).toFixed(1) + " M" : (v / 1e6).toFixed(1) + " Jt"; } catch (e) { formattedValue = 'N/A'; }
            playerEl.innerHTML = `<div class="flex items-center space-x-3 overflow-hidden"><img src="${player.profile_image_url || 'https://via.placeholder.com/100'}" alt="${player.name}" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-400 flex-shrink-0"><div class="overflow-hidden"><p class="font-bold truncate">${player.name}</p><p class="text-sm">${player.nationality} | <span class="font-medium">${formattedValue}</span></p></div></div><div class="player-position-badge">${player.position}</div>`;
            playerEl.addEventListener('click', () => handlePlayerSelect(player.id));
            playerListContainer.appendChild(playerEl);
        });
    }

    function renderClubSelect() {
        clubSelect.innerHTML = '<option value="">Semua Klub</option>';
        allClubs.forEach(club => { const o = document.createElement('option'); o.value = club.id; o.textContent = club.name; clubSelect.appendChild(o); });
    }

    function renderHistoryList() {
        historyListContainer.innerHTML = '';
        if (allHistory.length === 0) { historyListContainer.innerHTML = '<p class="italic text-sm p-4 text-center">Belum ada formasi tersimpan.</p>'; return; }
        allHistory.forEach(formation => {
            const h = document.createElement('div'); h.className = "history-item"; h.dataset.formationId = formation.id;
            h.innerHTML = `<h4 class="font-semibold">${formation.name}</h4><p class="text-sm">Layout: ${formation.layout}</p>`;
            h.addEventListener('click', () => loadFormation(formation.id));
            historyListContainer.appendChild(h);
        });
        highlightCurrentHistoryItem(); // Highlight setelah render ulang
    }

    // Fungsi helper baru untuk highlight history
    function highlightCurrentHistoryItem() {
         document.querySelectorAll('#history-list > div.history-item').forEach(el => {
            el.classList.remove('highlighted');
            if (currentFormationId && el.dataset.formationId == currentFormationId) {
                el.classList.add('highlighted');
            }
        });
    }

    // --- Event Handlers ---

    // handleSlotClick: Hapus dari currentSquad & selectedPlayers
    function handleSlotClick(slotId) {
        const playerInSlot = selectedPlayers.find(p => p.slotId === slotId);
        if (playerInSlot) {
            selectedPlayers = selectedPlayers.filter(p => p.slotId !== slotId);
            currentSquad = currentSquad.filter(s => s.player.id !== playerInSlot.player.id); // Hapus dari master
            selectedSlotId = null; currentFilterPositionCode = null;
            showStatus(`Pemain ${playerInSlot.player.name} dihapus.`);
            reAssignPlayersToPitch(); // PENTING: Assign ulang sisa pemain
            renderPlayerList(); // Update daftar pemain kanan
        } else {
            if (selectedSlotId === slotId) { selectedSlotId = null; currentFilterPositionCode = null; }
            else { selectedSlotId = slotId; currentFilterPositionCode = slotPositionMap[slotId]; showStatus(`Memilih pemain untuk ${slotId} (${currentFilterPositionCode})`); }
            renderPitchSlots(); // Update highlight slot saja
            renderPlayerList(); // Update filter pemain kanan
        }
        checkFormCompletion();
    }

    // handlePlayerSelect: Tambah ke currentSquad & selectedPlayers
    function handlePlayerSelect(playerId) {
        if (!selectedSlotId) { showStatus("Pilih slot dulu!", true); return; }
        if (currentSquad.length >= 11) { showStatus("Squad sudah penuh (11 pemain).", true); return; } // Batasi 11
        
        const player = currentPlayers.find(p => p.id === playerId);
        const expectedRole = slotPositionMap[selectedSlotId];
        const playerRoles = indonesianToRoleMap[player.position];
        if (!playerRoles || !playerRoles.includes(expectedRole)) { showStatus(`Posisi tidak cocok! Slot ${selectedSlotId} butuh ${expectedRole} (Pemain: ${player.position}).`, true); return; }

        // Cek duplikat di master squad
        if (currentSquad.find(s => s.player.id === player.id)) { showStatus(`${player.name} sudah ada di squad.`, true); return; }

        // Tambah ke Master Squad
        currentSquad.push({ player: player, originalSlotId: selectedSlotId });
        // Tambah ke Pemain di Lapangan
        selectedPlayers.push({ player: player, slotId: selectedSlotId });

        showStatus(`${player.name} ke slot ${selectedSlotId}.`);
        selectedSlotId = null; currentFilterPositionCode = null;
        renderPitchSlots();
        renderPlayerList();
        checkFormCompletion();
    }

    // handleLayoutChange: Hanya update layout & panggil reAssign
    function handleLayoutChange(event) {
        currentLayout = event.target.value;
        if (selectedSlotId) { selectedSlotId = null; currentFilterPositionCode = null; }
        reAssignPlayersToPitch(); // Panggil fungsi pintar
        renderPlayerList(); // Update daftar pemain (karena selectedPlayers berubah)
        checkFormCompletion();
    }

    // handleClubChange tidak berubah
    function handleClubChange() {
        const clubId = clubSelect.value;
        fetchPlayers(clubId);
        if (selectedSlotId) { document.getElementById(`slot-${selectedSlotId}`).classList.remove('selected'); selectedSlotId = null; }
        currentFilterPositionCode = null;
        renderPitchSlots(); // Mungkin tidak perlu, tapi aman
    }

    // handleClearFilter tidak berubah
    function handleClearFilter() {
        if (selectedSlotId) { document.getElementById(`slot-${selectedSlotId}`).classList.remove('selected'); selectedSlotId = null; }
        currentFilterPositionCode = null;
        renderPitchSlots();
        renderPlayerList();
    }

    // clearFormation: Mengosongkan currentSquad & selectedPlayers
    function clearFormation(showMsg = true) {
        selectedPlayers = []; currentSquad = []; // Kosongkan keduanya
        selectedSlotId = null; currentFilterPositionCode = null; currentFormationId = null;
        formationNameInput.value = '';
        formationLayoutSelect.value = '4-3-3'; currentLayout = '4-3-3'; // Reset layout
        reAssignPlayersToPitch(); // Akan render pitch kosong
        renderPlayerList();
        checkFormCompletion();
        highlightCurrentHistoryItem(); // Hapus highlight
        if (showMsg) showStatus("Formasi dibersihkan.", false, 3000);
    }

    // checkFormCompletion: Mengecek currentSquad
    function checkFormCompletion() {
        const isComplete = currentSquad.length === 11 && formationNameInput.value.trim() !== '';
        saveFormationBtn.disabled = !isComplete;
        saveFormationBtn.classList.toggle('opacity-50', !isComplete);
        saveFormationBtn.classList.toggle('cursor-not-allowed', !isComplete);
        if (isComplete) { saveFormationBtn.textContent = currentFormationId ? 'Update' : 'Simpan'; }
        else { saveFormationBtn.textContent = currentSquad.length !== 11 ? `Pilih ${11 - currentSquad.length} lagi` : 'Beri Nama'; }
    }

    // --- Utility Functions ---
    // showStatus tidak berubah
    function showStatus(message, isError = false, duration = 4000) {
        globalStatus.textContent = message;
        let className = 'mb-4 text-center min-h-[40px] font-semibold p-2 rounded-md';
        if (document.body.classList.contains('bg-gray-900')) { // Dark mode assumed
             className += isError ? ' text-red-300 bg-red-900/50' : ' text-green-300 bg-green-900/50';
        } else { // Light mode fallback
             className += isError ? ' text-red-600 bg-red-100' : ' text-green-700 bg-green-100';
        }
         globalStatus.className = className;
        if (!isError) { setTimeout(() => { if (globalStatus.textContent === message) { globalStatus.textContent = ''; globalStatus.className = 'mb-4 text-center min-h-[40px]'; } }, duration); }
    }

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchInitialData(); // Panggil AJAX
        clubSelect.addEventListener('change', handleClubChange);
        formationLayoutSelect.addEventListener('change', handleLayoutChange);
        saveFormationBtn.addEventListener('click', saveFormation);
        clearFormationBtn.addEventListener('click', () => clearFormation(true));
        clearFilterBtn.addEventListener('click', handleClearFilter);
        formationNameInput.addEventListener('input', checkFormCompletion);
        // renderPitchSlots(); // Dihapus, dipanggil oleh reAssign di fetchInitialData
        checkFormCompletion();
        window.addEventListener('resize', renderPitchSlots);
    });
</script>
{% endblock content %}