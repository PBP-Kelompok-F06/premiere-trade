{% extends 'base.html' %}
{% load static %}

{% block title %}Community - Premiere Trade{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'community/css/style.css' %}">
{% endblock %}

{% block content %}
<div class="forum-container">
    <h1>Community Premiere Trade</h1>

    <button class="add-forum-btn" id="toggleBtn">+ Tambah Forum</button>

    <div id="addForumForm" class="hidden">
        <form id="forumForm" method="POST">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Judul forum..." required>
            <textarea name="description" placeholder="Tulis deskripsi atau pandanganmu..." required></textarea>
            <input type="text" name="image_url" placeholder="Tempel URL gambar di sini (opsional)">
            <button type="submit">Kirim</button>
        </form>
    </div>

    <div class="forum-list">
        {% for post in posts %}
        <div class="forum-card" id="post-card-{{ post.id }}"> 
            {% if post.image_url %}
                <img src="{{ post.image_url }}" alt="{{ post.title }}" id="post-image-{{ post.id }}">
            {% endif %}

            <div class="forum-content">
                <h2 id="post-title-{{ post.id }}">{{ post.title }}</h2>
                <p id="post-desc-{{ post.id }}">{{ post.description }}</p>
                <small>Dibuat oleh {{ post.author }} ‚Ä¢ {{ post.created_at|date:"d M Y, H:i" }}</small>

                <div class="post-actions">
                    <button class="reply-btn" data-target-form="reply-form-post-{{ post.id }}">
                        üí¨ Reply ({{ post.replies.count }})
                    </button>

                    <div class="author-actions">
                        {% if post.author == user %}
                            <button class="edit-btn edit-btn-ajax" 
                                    data-target-form="edit-form-{{ post.id }}"
                                    data-edit-url="{% url 'community:edit_post' post.id %}">
                                ‚úèÔ∏è Edit
                            </button>
                          
                            <form action="{% url 'community:delete_post' post.id %}" method="POST" class="delete-form" onsubmit="return confirm('Yakin mau hapus post ini?');">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                
                <div class="edit-form-container hidden" id="edit-form-{{ post.id }}">
                    <form class="edit-form" data-post-id="{{ post.id }}">
                        <input type="text" name="title" value="{{ post.title }}" required>
                        <textarea name="description" rows="4" required>{{ post.description }}</textarea>
                        <input type="text" name="image_url" value="{{ post.image_url|default_if_none:'' }}" placeholder="URL Gambar (opsional)">
                        <button type="submit">Simpan</button>
                        <button type="button" class="cancel-edit-btn" data-target-form="edit-form-{{ post.id }}">Batal</button>
                    </form>
                </div>

                <div class="reply-form-container hidden" id="reply-form-post-{{ post.id }}">
                    <form action="{% url 'community:add_reply' post.id %}" method="POST" class="reply-form">
                        {% csrf_token %}
                        <textarea name="content" placeholder="Tulis balasanmu..." rows="3" required></textarea>
                        <button type="submit">Kirim Balasan</button>
                    </form>
                </div>

                <div class="replies-list" id="replies-for-post-{{ post.id }}">
                    {% for reply in post.top_level_replies %}
                        {% include "community/_reply.html" with reply=reply %}
                    {% empty %}
                        <small class="no-replies" id="no-reply-msg-{{ post.id }}">Belum ada balasan.</small>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% empty %}
        <p class="empty-msg">Belum ada forum. Jadilah yang pertama membuat diskusi!</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const csrfToken = document.querySelector('#forumForm [name=csrfmiddlewaretoken]').value;
    const forumList = document.querySelector('.forum-list');

    // Toggle form "Tambah Forum"
    const btn = document.getElementById("toggleBtn");
    const form = document.getElementById("addForumForm");
    if (btn && form) {
        btn.addEventListener("click", () => { form.classList.toggle("hidden"); });
    }

    // Toggle form "Reply" dan "Edit" menggunakan event delegation
    forumList.addEventListener("click", function(event) {
        // 1. Handle tombol "Reply"
        if (event.target.classList.contains("reply-btn")) {
            const formId = event.target.dataset.targetForm;
            const replyForm = document.getElementById(formId);
            if (replyForm) { replyForm.classList.toggle("hidden"); }
        }

        // 2. Handle tombol "Edit"
        if (event.target.classList.contains("edit-btn-ajax")) {
            const formId = event.target.dataset.targetForm;
            const editForm = document.getElementById(formId);
            if (editForm) { editForm.classList.toggle("hidden"); }
        }

        // 3. Handle tombol "Batal Edit"
        if (event.target.classList.contains("cancel-edit-btn")) {
            const formId = event.target.dataset.targetForm;
            const editForm = document.getElementById(formId);
            if (editForm) { editForm.classList.add("hidden"); }
        }
    });

    // Handle Submit Form Edit (AJAX)
    forumList.addEventListener("submit", function(event) {
        if (event.target.classList.contains("edit-form")) {
            event.preventDefault(); 

            const postId = event.target.dataset.postId;
            const editUrl = document.querySelector(`.edit-btn-ajax[data-target-form="edit-form-${postId}"]`).dataset.editUrl;
            
            const formData = {
                title: event.target.querySelector('[name="title"]').value,
                description: event.target.querySelector('[name="description"]').value,
                image_url: event.target.querySelector('[name="image_url"]').value
            };

            fetch(editUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`post-title-${postId}`).textContent = data.post.title;
                    document.getElementById(`post-desc-${postId}`).textContent = data.post.description;
                    const imgElement = document.getElementById(`post-image-${postId}`);
                    if (data.post.image_url) {
                        if (imgElement) {
                            imgElement.src = data.post.image_url;
                        } else {
                            const card = document.getElementById(`post-card-${postId}`);
                            const newImg = document.createElement('img');
                            newImg.id = `post-image-${postId}`;
                            newImg.src = data.post.image_url;
                            newImg.alt = data.post.title;
                            card.prepend(newImg);
                        }
                    } else if (imgElement) {
                        imgElement.remove();
                    }
                    event.target.parentElement.classList.add("hidden");
                } else {
                    alert("Gagal update: " + data.message);
                }
            })
            .catch(error => { console.error("Error:", error); alert("Terjadi kesalahan."); });
        }

        // ‚úÖ HANDLE SUBMIT REPLY FORM (AJAX) - SUPPORT NESTED
        if (event.target.classList.contains("reply-form")) {
            event.preventDefault();
            
            const form = event.target;
            const url = form.action;
            const formData = new FormData(form);

            fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Buat HTML untuk reply baru
                    const newReplyHTML = createReplyHTML(data.reply);
                    
                    // Tentukan di mana reply baru akan diletakkan
                    let targetList;
                    if (data.reply.parent_id) {
                        // ‚úÖ Ini adalah nested reply
                        const parentCard = document.getElementById(`reply-${data.reply.parent_id}`);
                        targetList = parentCard.querySelector('.nested-replies');
                    } else {
                        // ‚úÖ Ini adalah top-level reply
                        targetList = document.getElementById(`replies-for-post-${data.reply.post_id}`);
                        // Hapus pesan "Belum ada balasan" jika ada
                        const noReplyMsg = document.getElementById(`no-reply-msg-${data.reply.post_id}`);
                        if(noReplyMsg) { noReplyMsg.remove(); }
                    }
                    
                    // Tambahkan HTML ke DOM
                    targetList.insertAdjacentHTML('beforeend', newReplyHTML);
                    
                    // Kosongkan dan sembunyikan form
                    form.querySelector('textarea').value = '';
                    form.parentElement.classList.add('hidden');

                    // ==== ‚¨áÔ∏è TAMBAHKAN 4 BARIS INI ‚¨áÔ∏è ====
                    const postId = data.reply.post_id;
                    const mainReplyButton = document.querySelector(`.reply-btn[data-target-form="reply-form-post-${postId}"]`);
                    const match = mainReplyButton.textContent.match(/\((\d+)\)/);
                    mainReplyButton.textContent = `üí¨ Reply (${match ? parseInt(match[1]) + 1 : 1})`;
                    // ==== ‚¨ÜÔ∏è PERBAIKAN SELESAI ‚¨ÜÔ∏è ====
                } else {
                    alert("Gagal membalas: " + data.message);
                }
            })
            .catch(error => { console.error("Error:", error); alert("Terjadi kesalahan."); });
        }
    });

    // ‚úÖ FUNGSI UNTUK MEMBUAT HTML REPLY CARD BARU (Support Nested)
    function createReplyHTML(reply) {
        return `
        <div class="reply-card" id="reply-${reply.id}">
            <div class="reply-header">
                <strong>${reply.author_username}</strong>
                <small>‚Ä¢ ${reply.created_at}</small>
            </div>
            <p class="reply-content">${escapeHtml(reply.content)}</p>
            <div class="post-actions">
                <button class="reply-btn" data-target-form="reply-form-${reply.id}">
                    üí¨ Balas
                </button>
            </div>
            <div class="reply-form-container nested-form hidden" id="reply-form-${reply.id}">
                <form action="${reply.new_reply_url}" method="POST" class="reply-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                    <textarea name="content" placeholder="Balas ${reply.author_username}..." rows="2" required></textarea>
                    <button type="submit">Kirim Balasan</button>
                </form>
            </div>
            <div class="nested-replies"></div>
        </div>
        `;
    }

    // ‚úÖ Helper function untuk escape HTML (keamanan)
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
});
</script>
{% endblock %}